<div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a

        href="https://github.com/nathanpeck/s3-upload-stream"

    >s3-upload-stream (v1.0.7)</a>
</h1>
<h4>Writeable stream for uploading content of unknown size to S3 via the multipart API.</h4>
<div class="apidocSectionDiv"><a
    href="#apidoc.tableOfContents"
    id="apidoc.tableOfContents"
><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.s3-upload-stream">module s3-upload-stream</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.s3-upload-stream.s3-upload-stream">
            function <span class="apidocSignatureSpan"></span>s3-upload-stream
            <span class="apidocSignatureSpan">(client)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.s3-upload-stream.client">
            function <span class="apidocSignatureSpan">s3-upload-stream.</span>client
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.s3-upload-stream.s3_upload_stream">
            function <span class="apidocSignatureSpan">s3-upload-stream.</span>s3_upload_stream
            <span class="apidocSignatureSpan">(client)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.s3-upload-stream.toString">
            function <span class="apidocSignatureSpan">s3-upload-stream.</span>toString
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.s3-upload-stream.upload">
            function <span class="apidocSignatureSpan">s3-upload-stream.</span>upload
            <span class="apidocSignatureSpan">(destinationDetails, sessionDetails)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">s3-upload-stream.</span>globalClient</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">s3-upload-stream.</span>s3_upload_stream.prototype</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.s3-upload-stream.s3_upload_stream">module s3-upload-stream.s3_upload_stream</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.s3-upload-stream.s3_upload_stream.s3_upload_stream">
            function <span class="apidocSignatureSpan">s3-upload-stream.</span>s3_upload_stream
            <span class="apidocSignatureSpan">(client)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.s3-upload-stream.s3_upload_stream.client">
            function <span class="apidocSignatureSpan">s3-upload-stream.s3_upload_stream.</span>client
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.s3-upload-stream.s3_upload_stream.upload">
            function <span class="apidocSignatureSpan">s3-upload-stream.s3_upload_stream.</span>upload
            <span class="apidocSignatureSpan">(destinationDetails, sessionDetails)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">s3-upload-stream.s3_upload_stream.</span>globalClient</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.s3-upload-stream.s3_upload_stream.prototype">module s3-upload-stream.s3_upload_stream.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.s3-upload-stream.s3_upload_stream.prototype.upload">
            function <span class="apidocSignatureSpan">s3-upload-stream.s3_upload_stream.prototype.</span>upload
            <span class="apidocSignatureSpan">(destinationDetails, sessionDetails)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.s3-upload-stream" id="apidoc.module.s3-upload-stream">module s3-upload-stream</a></h1>


    <h2>
        <a href="#apidoc.element.s3-upload-stream.s3-upload-stream" id="apidoc.element.s3-upload-stream.s3-upload-stream">
        function <span class="apidocSignatureSpan"></span>s3-upload-stream
        <span class="apidocSignatureSpan">(client)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Client(client) {
  if (this instanceof Client === false) {
    return new Client(client);
  }

  if (!client) {
    throw new Error(&#x27;Must configure an S3 client before attempting to create an S3 upload stream.&#x27;);
  }

  this.cachedClient = client;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.s3-upload-stream.client" id="apidoc.element.s3-upload-stream.client">
        function <span class="apidocSignatureSpan">s3-upload-stream.</span>client
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">client = function (options) {
  Client.globalClient = new Client(options);
  return Client.globalClient;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.s3-upload-stream.s3_upload_stream" id="apidoc.element.s3-upload-stream.s3_upload_stream">
        function <span class="apidocSignatureSpan">s3-upload-stream.</span>s3_upload_stream
        <span class="apidocSignatureSpan">(client)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Client(client) {
  if (this instanceof Client === false) {
    return new Client(client);
  }

  if (!client) {
    throw new Error(&#x27;Must configure an S3 client before attempting to create an S3 upload stream.&#x27;);
  }

  this.cachedClient = client;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.s3-upload-stream.toString" id="apidoc.element.s3-upload-stream.toString">
        function <span class="apidocSignatureSpan">s3-upload-stream.</span>toString
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">toString = function () {
    return text;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.s3-upload-stream.upload" id="apidoc.element.s3-upload-stream.upload">
        function <span class="apidocSignatureSpan">s3-upload-stream.</span>upload
        <span class="apidocSignatureSpan">(destinationDetails, sessionDetails)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">upload = function (destinationDetails, sessionDetails) {
  if (!Client.globalClient) {
    throw new Error(&#x27;Must configure an S3 client before attempting to create an S3 upload stream.&#x27;);
  }
  return Client.globalClient.upload(destinationDetails, sessionDetails);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// Set the client to be used for the upload.
AWS.config.loadFromPath(&#x27;./config.json&#x27;);

// Create the streams
var read = fs.createReadStream(&#x27;/path/to/a/file&#x27;);
var compress = zlib.createGzip();
var upload = s3Stream.<span class="apidocCodeKeywordSpan">upload</span>({
  &#x22;Bucket&#x22;: &#x22;bucket-name&#x22;,
  &#x22;Key&#x22;: &#x22;key-name&#x22;
});

// Optional configuration
upload.maxPartSize(20971520); // 20 MB
upload.concurrentParts(5);
...</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.s3-upload-stream.s3_upload_stream" id="apidoc.module.s3-upload-stream.s3_upload_stream">module s3-upload-stream.s3_upload_stream</a></h1>


    <h2>
        <a href="#apidoc.element.s3-upload-stream.s3_upload_stream.s3_upload_stream" id="apidoc.element.s3-upload-stream.s3_upload_stream.s3_upload_stream">
        function <span class="apidocSignatureSpan">s3-upload-stream.</span>s3_upload_stream
        <span class="apidocSignatureSpan">(client)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Client(client) {
  if (this instanceof Client === false) {
    return new Client(client);
  }

  if (!client) {
    throw new Error(&#x27;Must configure an S3 client before attempting to create an S3 upload stream.&#x27;);
  }

  this.cachedClient = client;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.s3-upload-stream.s3_upload_stream.client" id="apidoc.element.s3-upload-stream.s3_upload_stream.client">
        function <span class="apidocSignatureSpan">s3-upload-stream.s3_upload_stream.</span>client
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">client = function (options) {
  Client.globalClient = new Client(options);
  return Client.globalClient;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.s3-upload-stream.s3_upload_stream.upload" id="apidoc.element.s3-upload-stream.s3_upload_stream.upload">
        function <span class="apidocSignatureSpan">s3-upload-stream.s3_upload_stream.</span>upload
        <span class="apidocSignatureSpan">(destinationDetails, sessionDetails)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">upload = function (destinationDetails, sessionDetails) {
  if (!Client.globalClient) {
    throw new Error(&#x27;Must configure an S3 client before attempting to create an S3 upload stream.&#x27;);
  }
  return Client.globalClient.upload(destinationDetails, sessionDetails);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// Set the client to be used for the upload.
AWS.config.loadFromPath(&#x27;./config.json&#x27;);

// Create the streams
var read = fs.createReadStream(&#x27;/path/to/a/file&#x27;);
var compress = zlib.createGzip();
var upload = s3Stream.<span class="apidocCodeKeywordSpan">upload</span>({
  &#x22;Bucket&#x22;: &#x22;bucket-name&#x22;,
  &#x22;Key&#x22;: &#x22;key-name&#x22;
});

// Optional configuration
upload.maxPartSize(20971520); // 20 MB
upload.concurrentParts(5);
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.s3-upload-stream.s3_upload_stream.prototype" id="apidoc.module.s3-upload-stream.s3_upload_stream.prototype">module s3-upload-stream.s3_upload_stream.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.s3-upload-stream.s3_upload_stream.prototype.upload" id="apidoc.element.s3-upload-stream.s3_upload_stream.prototype.upload">
        function <span class="apidocSignatureSpan">s3-upload-stream.s3_upload_stream.prototype.</span>upload
        <span class="apidocSignatureSpan">(destinationDetails, sessionDetails)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">upload = function (destinationDetails, sessionDetails) {
  var cachedClient = this.cachedClient;
  var e = new events.EventEmitter();

  if (!sessionDetails) sessionDetails = {};

  // Create the writable stream interface.
  var ws = new Writable({
    highWaterMark: 4194304 // 4 MB
  });

  // Data pertaining to the overall upload.
  // If resumable parts are passed in, they must be free of gaps.
  var multipartUploadID = sessionDetails.UploadId ? sessionDetails.UploadId : null;
  var partNumber = sessionDetails.Parts ? (sessionDetails.Parts.length + 1) : 1;
  var partIds = sessionDetails.Parts || [];
  var receivedSize = 0;
  var uploadedSize = 0;

  // Light state management -
  //   started: used to fire &#x27;ready&#x27; even on a quick resume
  //   paused:  used to govern manual pause/resume
  var started = false;
  var paused = false;

  // Parts which need to be uploaded to S3.
  var pendingParts = 0;
  var concurrentPartThreshold = 1;

  // Data pertaining to buffers we have received
  var receivedBuffers = [];
  var receivedBuffersLength = 0;
  var partSizeThreshold = 5242880;

  // Set the maximum amount of data that we will keep in memory before flushing it to S3 as a part
  // of the multipart upload
  ws.maxPartSize = function (partSize) {
    if (partSize &#x3c; 5242880)
      partSize = 5242880;

    partSizeThreshold = partSize;
    return ws;
  };

  ws.getMaxPartSize = function () {
    return partSizeThreshold;
  };

  // Set the maximum amount of data that we will keep in memory before flushing it to S3 as a part
  // of the multipart upload
  ws.concurrentParts = function (parts) {
    if (parts &#x3c; 1)
      parts = 1;

    concurrentPartThreshold = parts;
    return ws;
  };

  ws.getConcurrentParts = function () {
    return concurrentPartThreshold;
  };

  // Handler to receive data and upload it to S3.
  ws._write = function (incomingBuffer, enc, next) {
    // Pause/resume check #1 out of 2:
    //   Block incoming writes immediately on pause.
    if (paused)
      e.once(&#x27;resume&#x27;, write);
    else
      write();

    function write() {
      absorbBuffer(incomingBuffer);

      if (receivedBuffersLength &#x3c; partSizeThreshold)
        return next(); // Ready to receive more data in _write.

      // We need to upload some data
      uploadHandler(next);
    }
  };

  // Ask the stream to pause - will allow existing
  // part uploads to complete first.
  ws.pause = function () {
    // if already mid-pause, this does nothing
    if (paused) return false;

    // if there&#x27;s no active upload, this does nothing
    if (!started) return false;

    paused = true;
    // give caller how many parts are mid-upload
    ws.emit(&#x27;pausing&#x27;, pendingParts);

    // if there are no parts outstanding, declare the stream
    // paused and return currently sent part details.
    if (pendingParts === 0)
      notifyPaused();

    // otherwise, the &#x27;paused&#x27; event will get sent once the
    // last part finishes uploading.

    return true;
  };

  // Lift the pause, and re-kick off the uploading.
  ws.resume = function () {
    // if we&#x27;re not paused, this does nothing
    if (!paused) return false;

    paused = false;
    e.emit(&#x27;resume&#x27;); // internal event
    ws.emit(&#x27;resume&#x27;); // external event

    return true;
  };

  // when pausing, return relevant pause state to client
  var notifyPaused = function () {
    ws.emit(&#x27;paused&#x27;, {
      UploadId: multipartUploadID,
      Parts: partIds,
      uploadedSize: uploadedSize
    });
  };

  // Concurrently upload parts to S3.
  var uploadHandler = function (next) {

    // If this is the first part, and we&#x27;re just starting,
    // but we have a multipartUploadID, then we&#x27;re beginning
    // a resume and can fire the &#x27;ready&#x27; event externally.
    if (multipartUploadID &#x26;&#x26; !started)
      ws.emit(&#x27;ready&#x27;, multipartUploadID);

    started = true;

    if (pendingParts &#x3c; concurrentPartThreshold) {
      // Has the MPU been created yet?
      if (multipartUploadID)
        upload(); // Upload the part immediately.
      else {
        e.once(&#x27;ready&#x27;, upload); // Wait until multipart upload is ini ...</pre></li>
    <li>example usage<pre class="apidocCodePre">...

// Set the client to be used for the upload.
AWS.config.loadFromPath(&#x27;./config.json&#x27;);

// Create the streams
var read = fs.createReadStream(&#x27;/path/to/a/file&#x27;);
var compress = zlib.createGzip();
var upload = s3Stream.<span class="apidocCodeKeywordSpan">upload</span>({
  &#x22;Bucket&#x22;: &#x22;bucket-name&#x22;,
  &#x22;Key&#x22;: &#x22;key-name&#x22;
});

// Optional configuration
upload.maxPartSize(20971520); // 20 MB
upload.concurrentParts(5);
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
